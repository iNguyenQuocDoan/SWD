name: CI/CD Pipeline

on:
    push:
        branches:
            - main
            - master
            - develop
    pull_request:
        branches:
            - main
            - master
            - develop

jobs:
    # Backend CI
    backend-ci:
        name: Backend CI
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: ./BE

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "yarn"
                  cache-dependency-path: BE/yarn.lock

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Run linter
              run: yarn lint || true

            - name: Type check
              run: yarn type-check

            - name: Build project
              run: yarn build

            - name: Check build output
              run: |
                  if [ ! -d "dist" ]; then
                    echo "Build failed: dist directory not found"
                    exit 1
                  fi

    # Frontend CI
    frontend-ci:
        name: Frontend CI
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: ./FE

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "yarn"
                  cache-dependency-path: FE/yarn.lock

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Run linter
              run: yarn lint || true

            - name: Build project
              run: yarn build
              env:
                  NODE_ENV: production

    # Deploy to Vercel (Monorepo - Both BE and FE)
    deploy:
        name: Deploy to Vercel
        needs: [backend-ci, frontend-ci]
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install Vercel CLI
              run: npm install -g vercel@latest

            - name: Link Vercel Project
              run: |
                  mkdir -p .vercel
                  cat > .vercel/project.json << EOF
                  {
                    "projectId": "${{ secrets.VERCEL_PROJECT_ID }}",
                    "orgId": "${{ secrets.VERCEL_ORG_ID }}"
                  }
                  EOF
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

            - name: Deploy to Vercel
              run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
