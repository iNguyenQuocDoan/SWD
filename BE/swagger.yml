openapi: 3.0.4
info:
  title: Marketplace API
  description: |
    API documentation for Digital Marketplace Backend
    
    ## Authentication
    Most endpoints require authentication. Include the JWT token in the Authorization header:
    ```
    Authorization: Bearer <your-token>
    ```
    
    ## Roles
    - **CUSTOMER**: Regular customer who can purchase products
    - **SELLER**: Seller who can create and manage products
    - **ADMIN**: System administrator with full access
    - **MODERATOR**: Moderator who can review and manage content
  version: 1.0.0
  contact:
    email: support@marketplace.com
  license:
    name: ISC

servers:
  - url: http://localhost:3001
    description: Local development server
  - url: http://localhost:9999
    description: Alternative local port

tags:
  - name: Auth
    description: Authentication endpoints
  - name: Users
    description: User management endpoints
  - name: Products
    description: Product management endpoints
  - name: Shops
    description: Shop management endpoints

paths:
  /health:
    get:
      summary: Health check
      description: Check if the server is running
      tags:
        - Health
      responses:
        '200':
          description: Server is running
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  environment:
                    type: string
                    example: development

  /api/auth/register:
    post:
      summary: Register a new user
      description: Register a new customer account
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - fullName
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 6
                  example: password123
                fullName:
                  type: string
                  minLength: 2
                  example: John Doe
                phone:
                  type: string
                  nullable: true
                  example: "+84123456789"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: User registered successfully
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      fullName:
                        type: string
        '400':
          description: Bad request (email already exists, validation error)
        '500':
          description: Internal server error

  /api/auth/register/seller:
    post:
      summary: Register a new seller
      description: Register a new seller account
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - fullName
              properties:
                email:
                  type: string
                  format: email
                  example: seller@example.com
                password:
                  type: string
                  format: password
                  minLength: 6
                  example: password123
                fullName:
                  type: string
                  minLength: 2
                  example: Jane Seller
                phone:
                  type: string
                  nullable: true
      responses:
        '201':
          description: Seller registered successfully
        '400':
          description: Bad request
        '500':
          description: Internal server error

  /api/auth/login:
    post:
      summary: Login
      description: Authenticate user and get JWT tokens
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Login successful
                  data:
                    type: object
                    properties:
                      user:
                        type: object
                        properties:
                          id:
                            type: string
                          email:
                            type: string
                          fullName:
                            type: string
                          roleKey:
                            type: string
                            enum: [CUSTOMER, SELLER, ADMIN, MODERATOR]
                      token:
                        type: string
                        description: JWT access token
                      refreshToken:
                        type: string
                        description: JWT refresh token
        '401':
          description: Invalid email or password
        '403':
          description: Account is locked or banned
        '429':
          description: Too many login attempts

  /api/auth/refresh:
    post:
      summary: Refresh access token
      description: Get a new access token using refresh token
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      token:
                        type: string
        '401':
          description: Invalid refresh token

  /api/auth/logout:
    post:
      summary: Logout
      description: Logout user (clears refresh token cookie)
      tags:
        - Auth
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                    example: Logout successful

  /api/auth/me:
    get:
      summary: Get current user
      description: Get information about the currently authenticated user
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      fullName:
                        type: string
                      phone:
                        type: string
                        nullable: true
                      avatarUrl:
                        type: string
                        nullable: true
                      roleKey:
                        type: string
                      roleName:
                        type: string
                      emailVerified:
                        type: boolean
                      phoneVerified:
                        type: boolean
                      trustLevel:
                        type: number
                      status:
                        type: string
                        enum: [Active, Locked, Banned]
                      createdAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
        '401':
          description: Unauthorized

  /api/auth/change-password:
    put:
      summary: Change password
      description: Change user password (requires authentication)
      tags:
        - Auth
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                  format: password
                  example: oldpassword123
                newPassword:
                  type: string
                  format: password
                  minLength: 6
                  example: newpassword123
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                    example: Password changed successfully
        '400':
          description: Current password is incorrect
        '401':
          description: Unauthorized

  # Shop endpoints
  /api/shops:
    post:
      summary: Create shop (Seller application)
      description: Customer creates a shop to become a seller. Shop will be pending until approved by moderator.
      tags:
        - Shops
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - shopName
              properties:
                shopName:
                  type: string
                  minLength: 2
                  maxLength: 100
                  example: My Awesome Shop
                description:
                  type: string
                  maxLength: 500
                  nullable: true
                  example: This is my shop description
      responses:
        '201':
          description: Shop created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '400':
          description: Bad request (shop already exists, validation error)
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (no permission)

  /api/shops/me/my-shop:
    get:
      summary: Get my shop
      description: Get the current user's shop
      tags:
        - Shops
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Shop details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '401':
          description: Unauthorized
        '404':
          description: Shop not found

  /api/shops/applications/pending:
    get:
      summary: Get pending shop applications (Moderator)
      description: Get all shops pending approval. Requires SELLER_VIEW_APPLICATIONS permission.
      tags:
        - Shops
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of pending shops
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Shop'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (no permission)

  /api/shops/{shopId}:
    get:
      summary: Get shop by ID
      description: Get shop details by ID (public)
      tags:
        - Shops
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Shop details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '404':
          description: Shop not found
    put:
      summary: Update shop
      description: Update shop details. Only shop owner can update.
      tags:
        - Shops
      security:
        - bearerAuth: []
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                shopName:
                  type: string
                  minLength: 2
                  maxLength: 100
                description:
                  type: string
                  maxLength: 500
                  nullable: true
      responses:
        '200':
          description: Shop updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not shop owner)
        '404':
          description: Shop not found

  /api/shops/{shopId}/approve:
    patch:
      summary: Approve shop (Moderator)
      description: Approve a pending shop application. Requires SELLER_APPROVE permission.
      tags:
        - Shops
      security:
        - bearerAuth: []
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                moderatorNote:
                  type: string
                  maxLength: 1000
                  example: Approved. Welcome to the platform!
      responses:
        '200':
          description: Shop approved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (no permission)
        '404':
          description: Shop not found

  /api/shops/{shopId}/reject:
    patch:
      summary: Reject shop (Moderator)
      description: Reject a pending shop application. Requires SELLER_REJECT permission.
      tags:
        - Shops
      security:
        - bearerAuth: []
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                moderatorNote:
                  type: string
                  maxLength: 1000
                  example: Please provide more details about your shop.
      responses:
        '200':
          description: Shop rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (no permission)
        '404':
          description: Shop not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Enter JWT token

  schemas:
    Shop:
      type: object
      properties:
        _id:
          type: string
        ownerUserId:
          type: string
        shopName:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [Pending, Active, Suspended, Closed]
        approvedByUserId:
          type: string
          nullable: true
        approvedAt:
          type: string
          format: date-time
          nullable: true
        moderatorNote:
          type: string
          nullable: true
        ratingAvg:
          type: number
        totalSales:
          type: number
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ShopResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          $ref: '#/components/schemas/Shop'
