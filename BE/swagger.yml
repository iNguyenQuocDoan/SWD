openapi: 3.0.4
info:
  title: Marketplace API
  description: |
    API documentation for Digital Marketplace Backend
    
    ## Authentication
    Most endpoints require authentication. Include the JWT token in the Authorization header:
    ```
    Authorization: Bearer <your-token>
    ```
    
    ## Roles
    - **CUSTOMER**: Regular customer who can purchase products
    - **SELLER**: Seller who can create and manage products
    - **ADMIN**: System administrator with full access
    - **MODERATOR**: Moderator who can review and manage content
  version: 1.0.0
  contact:
    email: support@marketplace.com
  license:
    name: ISC

servers:
  - url: http://localhost:3001
    description: Local development server
  - url: http://localhost:9999
    description: Alternative local port

tags:
  - name: Auth
    description: Authentication endpoints
  - name: Users
    description: User management endpoints
  - name: Products
    description: Product management endpoints
  - name: Shops
    description: Shop management endpoints

paths:
  /health:
    get:
      summary: Health check
      description: Check if the server is running
      tags:
        - Health
      responses:
        '200':
          description: Server is running
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  environment:
                    type: string
                    example: development

  /api/auth/register:
    post:
      summary: Register a new user
      description: Register a new customer account
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - fullName
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 6
                  example: password123
                fullName:
                  type: string
                  minLength: 2
                  example: John Doe
                phone:
                  type: string
                  nullable: true
                  example: "+84123456789"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: User registered successfully
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      fullName:
                        type: string
        '400':
          description: Bad request (email already exists, validation error)
        '500':
          description: Internal server error

  /api/auth/register/seller:
    post:
      summary: Register a new seller
      description: Register a new seller account
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - fullName
              properties:
                email:
                  type: string
                  format: email
                  example: seller@example.com
                password:
                  type: string
                  format: password
                  minLength: 6
                  example: password123
                fullName:
                  type: string
                  minLength: 2
                  example: Jane Seller
                phone:
                  type: string
                  nullable: true
      responses:
        '201':
          description: Seller registered successfully
        '400':
          description: Bad request
        '500':
          description: Internal server error

  /api/auth/login:
    post:
      summary: Login
      description: Authenticate user and get JWT tokens
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Login successful
                  data:
                    type: object
                    properties:
                      user:
                        type: object
                        properties:
                          id:
                            type: string
                          email:
                            type: string
                          fullName:
                            type: string
                          roleKey:
                            type: string
                            enum: [CUSTOMER, SELLER, ADMIN, MODERATOR]
                      token:
                        type: string
                        description: JWT access token
                      refreshToken:
                        type: string
                        description: JWT refresh token
        '401':
          description: Invalid email or password
        '403':
          description: Account is locked or banned
        '429':
          description: Too many login attempts

  /api/auth/refresh:
    post:
      summary: Refresh access token
      description: Get a new access token using refresh token
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      token:
                        type: string
        '401':
          description: Invalid refresh token

  /api/auth/logout:
    post:
      summary: Logout
      description: Logout user (clears refresh token cookie)
      tags:
        - Auth
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                    example: Logout successful

  /api/auth/me:
    get:
      summary: Get current user
      description: Get information about the currently authenticated user
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      fullName:
                        type: string
                      phone:
                        type: string
                        nullable: true
                      avatarUrl:
                        type: string
                        nullable: true
                      roleKey:
                        type: string
                      roleName:
                        type: string
                      emailVerified:
                        type: boolean
                      phoneVerified:
                        type: boolean
                      trustLevel:
                        type: number
                      status:
                        type: string
                        enum: [Active, Locked, Banned]
                      createdAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
        '401':
          description: Unauthorized

  /api/auth/change-password:
    put:
      summary: Change password
      description: Change user password (requires authentication)
      tags:
        - Auth
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                  format: password
                  example: oldpassword123
                newPassword:
                  type: string
                  format: password
                  minLength: 6
                  example: newpassword123
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                    example: Password changed successfully
        '400':
          description: Current password is incorrect
        '401':
          description: Unauthorized

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Enter JWT token
