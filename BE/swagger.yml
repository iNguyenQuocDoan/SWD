openapi: 3.0.4
info:
  title: Marketplace API
  description: |
    API documentation for Digital Marketplace Backend

    ## Authentication
    Most endpoints require authentication. Include the JWT token in the Authorization header:
    ```
    Authorization: Bearer <your-token>
    ```

    ## Roles
    - **CUSTOMER**: Regular customer who can purchase products
    - **SELLER**: Seller who can create and manage products
    - **ADMIN**: System administrator with full access
    - **MODERATOR**: Moderator who can review and manage content
  version: 1.0.0
  contact:
    email: support@marketplace.com
  license:
    name: ISC

servers:
  - url: http://localhost:3001
    description: Local development server
  - url: http://localhost:9999
    description: Alternative local port

tags:
  - name: Health
    description: Health check endpoints
  - name: Auth
    description: Authentication endpoints
  - name: Users
    description: User management endpoints
  - name: Shops
    description: Shop management endpoints
  - name: Products
    description: Product management endpoints
  - name: Orders
    description: Order management endpoints
  - name: Uploads
    description: File upload endpoints
  - name: Support
    description: Chat, Conversations, Messages and Support Tickets

paths:
  /health:
    get:
      summary: Health check
      description: Check if the server is running
      tags:
        - Health
      responses:
        '200':
          description: Server is running
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  environment:
                    type: string
                    example: development

  /api/auth/register:
    post:
      summary: Register a new user
      description: Register a new customer account
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - fullName
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: Aa@12345
                fullName:
                  type: string
                  minLength: 2
                  example: John Doe
                phone:
                  type: string
                  nullable: true
                  example: "+84123456789"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: User registered successfully
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      fullName:
                        type: string
        '400':
          description: Bad request (email already exists, validation error)
        '500':
          description: Internal server error

  /api/auth/register/seller:
    post:
      summary: Register a new seller
      description: Register a new seller account
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - fullName
              properties:
                email:
                  type: string
                  format: email
                  example: seller@example.com
                password:
                  type: string
                  format: password
                  example: Aa@12345
                fullName:
                  type: string
                  minLength: 2
                  example: Jane Seller
                phone:
                  type: string
                  nullable: true
      responses:
        '201':
          description: Seller registered successfully
        '400':
          description: Bad request
        '500':
          description: Internal server error

  /api/auth/login:
    post:
      summary: Login
      description: Authenticate user and get JWT tokens
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: Aa@12345
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Login successful
                  data:
                    type: object
                    properties:
                      user:
                        type: object
                        properties:
                          id:
                            type: string
                          email:
                            type: string
                          fullName:
                            type: string
                          roleKey:
                            type: string
                            enum: [CUSTOMER, SELLER, ADMIN, MODERATOR]
                      token:
                        type: string
                        description: JWT access token
                      refreshToken:
                        type: string
                        description: JWT refresh token
        '401':
          description: Invalid email or password
        '403':
          description: Account is locked or banned
        '429':
          description: Too many login attempts

  /api/auth/refresh:
    post:
      summary: Refresh access token
      description: Get a new access token using refresh token
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      token:
                        type: string
        '401':
          description: Invalid refresh token

  /api/auth/logout:
    post:
      summary: Logout
      description: Logout user (clears refresh token cookie)
      tags:
        - Auth
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                    example: Logout successful

  /api/auth/me:
    get:
      summary: Get current user
      description: Get information about the currently authenticated user
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      fullName:
                        type: string
                      phone:
                        type: string
                        nullable: true
                      avatarUrl:
                        type: string
                        nullable: true
                      roleKey:
                        type: string
                      roleName:
                        type: string
                      emailVerified:
                        type: boolean
                      phoneVerified:
                        type: boolean
                      trustLevel:
                        type: number
                      status:
                        type: string
                        enum: [Active, Locked, Banned]
                      createdAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
        '401':
          description: Unauthorized

  /api/auth/change-password:
    put:
      summary: Change password
      description: Change user password (requires authentication)
      tags:
        - Auth
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                  format: password
                  example: OldPass@123
                newPassword:
                  type: string
                  format: password
                  example: NewPass@123
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                    example: Password changed successfully
        '400':
          description: Current password is incorrect
        '401':
          description: Unauthorized

  # User endpoints
  /api/users/profile:
    get:
      summary: Get my profile
      tags:
        - Users
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
    put:
      summary: Update my profile
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /api/users/{userId}:
    get:
      summary: Get user by ID (Admin)
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: User not found

  # Upload endpoints
  /api/uploads/image:
    post:
      summary: Upload product image (single)
      description: Upload an image file and get a public URL. Requires authentication.
      tags:
        - Uploads
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '201':
          description: Uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      filename:
                        type: string
                      mimetype:
                        type: string
                      size:
                        type: integer
                      path:
                        type: string
                        example: uploads/1700000000000-123.png
                      url:
                        type: string
                        example: /uploads/1700000000000-123.png
        '400':
          description: Bad request
        '401':
          description: Unauthorized

  # Shop endpoints
  /api/shops:
    post:
      summary: Create shop (Seller application)
      description: Customer creates a shop to become a seller. Shop will be pending until approved by moderator.
      tags:
        - Shops
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - shopName
              properties:
                shopName:
                  type: string
                  minLength: 2
                  maxLength: 100
                  example: My Awesome Shop
                description:
                  type: string
                  maxLength: 500
                  nullable: true
                  example: This is my shop description
      responses:
        '201':
          description: Shop created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '400':
          description: Bad request (shop already exists, validation error)
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (no permission)

  /api/shops/me/my-shop:
    get:
      summary: Get my shop
      description: Get the current user's shop
      tags:
        - Shops
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Shop details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '401':
          description: Unauthorized
        '404':
          description: Shop not found

  /api/shops/applications/pending:
    get:
      summary: Get pending shop applications (Moderator)
      description: Get all shops pending approval. Requires SELLER_VIEW_APPLICATIONS permission.
      tags:
        - Shops
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of pending shops
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Shop'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (no permission)

  /api/shops/{shopId}:
    get:
      summary: Get shop by ID
      description: Get shop details by ID (public)
      tags:
        - Shops
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Shop details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '404':
          description: Shop not found
    put:
      summary: Update shop
      description: Update shop details. Only shop owner can update.
      tags:
        - Shops
      security:
        - bearerAuth: []
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                shopName:
                  type: string
                  minLength: 2
                  maxLength: 100
                description:
                  type: string
                  maxLength: 500
                  nullable: true
      responses:
        '200':
          description: Shop updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not shop owner)
        '404':
          description: Shop not found

  /api/shops/{shopId}/approve:
    patch:
      summary: Approve shop (Moderator)
      description: Approve a pending shop application. Requires SELLER_APPROVE permission.
      tags:
        - Shops
      security:
        - bearerAuth: []
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                moderatorNote:
                  type: string
                  maxLength: 1000
                  example: Approved. Welcome to the platform!
      responses:
        '200':
          description: Shop approved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (no permission)
        '404':
          description: Shop not found

  /api/shops/{shopId}/reject:
    patch:
      summary: Reject shop (Moderator)
      description: Reject a pending shop application. Requires SELLER_REJECT permission.
      tags:
        - Shops
      security:
        - bearerAuth: []
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                moderatorNote:
                  type: string
                  maxLength: 1000
                  example: Please provide more details about your shop.
      responses:
        '200':
          description: Shop rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (no permission)
        '404':
          description: Shop not found

  # Product endpoints
  /api/products:
    get:
      summary: List products (public)
      description: List products. Products are published immediately by seller.
      tags:
        - Products
      parameters:
        - name: shopId
          in: query
          required: false
          schema:
            type: string
        - name: platformId
          in: query
          required: false
          schema:
            type: string
        - name: planType
          in: query
          required: false
          schema:
            type: string
            enum: [Personal, Family, Slot, Shared, InviteLink]
        - name: minPrice
          in: query
          required: false
          schema:
            type: number
        - name: maxPrice
          in: query
          required: false
          schema:
            type: number
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Products list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                      totalPages:
                        type: integer
    post:
      summary: Create product (Seller)
      description: Create product. Product is published immediately (no moderator approval).
      tags:
        - Products
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreateRequest'
      responses:
        '201':
          description: Product created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Product'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /api/products/{productId}:
    get:
      summary: Get product by ID (public)
      tags:
        - Products
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Product details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Product'
        '404':
          description: Product not found
    put:
      summary: Update product (Seller)
      tags:
        - Products
      security:
        - bearerAuth: []
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductUpdateRequest'
      responses:
        '200':
          description: Product updated
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Product not found
    delete:
      summary: Delete product (Seller)
      tags:
        - Products
      security:
        - bearerAuth: []
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Product deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Product not found

  /api/products/shop/{shopId}:
    get:
      summary: Get products of my shop (Seller)
      tags:
        - Products
      security:
        - bearerAuth: []
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Products list
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /api/products/me/{productId}:
    get:
      summary: Get my product by ID (Seller)
      tags:
        - Products
      security:
        - bearerAuth: []
      parameters:
        - name: productId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Product
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Product not found

  # Orders endpoints
  /api/orders/seller/items:
    get:
      summary: Get order items for current seller
      description: Returns flattened order items with customer info, product info and delivered credential (decrypted).
      tags:
        - Orders
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
        - name: skip
          in: query
          required: false
          schema:
            type: integer
            default: 0
        - name: status
          in: query
          required: false
          schema:
            type: string
            description: Filter by itemStatus (e.g. Delivered, WaitingDelivery, Disputed, Completed, Refunded)
      responses:
        '200':
          description: Seller order items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SellerOrderItemsResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  # Support - Conversations
  /api/support/conversations:
    get:
      summary: Get conversations
      description: Get conversations for current user based on their role
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [OrderItem, Shop, Support]
        - name: status
          in: query
          schema:
            type: string
            enum: [Open, Closed, Blocked]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Conversations list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationsResponse'
        '401':
          description: Unauthorized
    post:
      summary: Create conversation
      description: Create a new conversation (Shop or OrderItem type)
      tags:
        - Support
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
      responses:
        '201':
          description: Conversation created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized

  /api/support/conversations/unread-count:
    get:
      summary: Get total unread count
      description: Get total unread messages count across all conversations
      tags:
        - Support
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Unread count
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      unreadCount:
                        type: integer
        '401':
          description: Unauthorized

  /api/support/conversations/{id}:
    get:
      summary: Get conversation by ID
      description: Get conversation details with access control
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Conversation details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Conversation not found

  /api/support/conversations/{id}/status:
    patch:
      summary: Update conversation status
      description: Update conversation status (Close, Block)
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [Open, Closed, Blocked]
      responses:
        '200':
          description: Status updated
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Conversation not found

  /api/support/conversations/{id}/read:
    post:
      summary: Mark conversation as read
      description: Mark all messages in conversation as read for current user
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Marked as read
        '401':
          description: Unauthorized
        '404':
          description: Conversation not found

  # Support - Messages
  /api/support/messages:
    post:
      summary: Send message
      description: Send a message to a conversation
      tags:
        - Support
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /api/support/messages/{conversationId}:
    get:
      summary: Get messages
      description: Get messages for a conversation with pagination
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: before
          in: query
          description: Get messages before this timestamp (for pagination)
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Messages list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessagesResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /api/support/messages/{id}:
    delete:
      summary: Delete message
      description: Soft delete a message (only sender can delete)
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Message deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Message not found

  /api/support/messages/search:
    get:
      summary: Search messages
      description: Search messages across conversations
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
        '401':
          description: Unauthorized

  # Support - Tickets
  /api/support/tickets:
    get:
      summary: Get tickets
      description: Get support tickets with filtering
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [Open, InReview, NeedMoreInfo, Resolved, Closed]
        - name: priority
          in: query
          schema:
            type: string
            enum: [Low, Medium, High, Urgent]
        - name: type
          in: query
          schema:
            type: string
            enum: [Complaint, Dispute, General]
        - name: assignedToUserId
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Tickets list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketsResponse'
        '401':
          description: Unauthorized
    post:
      summary: Create ticket
      description: Create a support ticket for an order item
      tags:
        - Support
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTicketRequest'
      responses:
        '201':
          description: Ticket created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      ticket:
                        $ref: '#/components/schemas/Ticket'
                      conversationId:
                        type: string
        '400':
          description: Bad request
        '401':
          description: Unauthorized

  /api/support/tickets/stats:
    get:
      summary: Get ticket statistics
      description: Get ticket statistics (count by status, priority, avg resolution time)
      tags:
        - Support
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Ticket stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/TicketStats'
        '401':
          description: Unauthorized

  /api/support/tickets/{id}:
    get:
      summary: Get ticket by ID
      description: Get ticket details with access control
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Ticket details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Ticket not found
    patch:
      summary: Update ticket
      description: Update ticket (status, priority, resolution)
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTicketRequest'
      responses:
        '200':
          description: Ticket updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Ticket not found

  /api/support/tickets/{id}/assign:
    post:
      summary: Assign ticket to staff
      description: Assign ticket to a staff member (Moderator/Admin only)
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - staffUserId
              properties:
                staffUserId:
                  type: string
      responses:
        '200':
          description: Ticket assigned
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Ticket not found

  /api/support/tickets/{id}/escalate:
    post:
      summary: Escalate ticket
      description: Escalate ticket priority (Moderator/Admin only)
      tags:
        - Support
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Ticket escalated
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Ticket not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Enter JWT token

  schemas:
    UserProfile:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        fullName:
          type: string
        phone:
          type: string
          nullable: true
        avatarUrl:
          type: string
          nullable: true
        roleKey:
          type: string
        roleName:
          type: string
        emailVerified:
          type: boolean
        phoneVerified:
          type: boolean
        trustLevel:
          type: number
        status:
          type: string
          enum: [Active, Locked, Banned]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserProfileUpdateRequest:
      type: object
      properties:
        fullName:
          type: string
          minLength: 2
        phone:
          type: string
          nullable: true
        avatarUrl:
          type: string
          nullable: true

    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        fullName:
          type: string
        roleKey:
          type: string
        status:
          type: string
          enum: [Active, Locked, Banned]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Shop:
      type: object
      properties:
        _id:
          type: string
        ownerUserId:
          type: string
        shopName:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [Pending, Active, Suspended, Closed]
        approvedByUserId:
          type: string
          nullable: true
        approvedAt:
          type: string
          format: date-time
          nullable: true
        moderatorNote:
          type: string
          nullable: true
        ratingAvg:
          type: number
        totalSales:
          type: number
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ShopResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          $ref: '#/components/schemas/Shop'

    Product:
      type: object
      properties:
        _id:
          type: string
        shopId:
          type: string
        platformId:
          type: string
        title:
          type: string
        description:
          type: string
        warrantyPolicy:
          type: string
        howToUse:
          type: string
        thumbnailUrl:
          type: string
          nullable: true
        planType:
          type: string
          enum: [Personal, Family, Slot, Shared, InviteLink]
        durationDays:
          type: integer
        price:
          type: number
        status:
          type: string
          enum: [Approved, Hidden, Rejected, Pending]
        approvedByUserId:
          type: string
          nullable: true
        approvedAt:
          type: string
          format: date-time
          nullable: true
        rejectionReason:
          type: string
          nullable: true
        isDeleted:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProductCreateRequest:
      type: object
      required:
        - shopId
        - platformId
        - title
        - description
        - warrantyPolicy
        - howToUse
        - planType
        - durationDays
        - price
      properties:
        shopId:
          type: string
        platformId:
          type: string
        title:
          type: string
        description:
          type: string
        warrantyPolicy:
          type: string
        howToUse:
          type: string
        thumbnailUrl:
          type: string
          nullable: true
        planType:
          type: string
          enum: [Personal, Family, Slot, Shared, InviteLink]
        durationDays:
          type: integer
        price:
          type: number

    ProductUpdateRequest:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        warrantyPolicy:
          type: string
        howToUse:
          type: string
        thumbnailUrl:
          type: string
          nullable: true
        planType:
          type: string
          enum: [Personal, Family, Slot, Shared, InviteLink]
        durationDays:
          type: integer
        price:
          type: number

    SellerOrderItemCustomer:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
        fullName:
          type: string

    SellerOrderItemProduct:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        planType:
          type: string
          enum: [Personal, Family, Slot, Shared, InviteLink]
        durationDays:
          type: integer
        thumbnailUrl:
          type: string
          nullable: true

    SellerOrderItem:
      type: object
      properties:
        id:
          type: string
        orderCode:
          type: string
        orderCreatedAt:
          type: string
          format: date-time
          nullable: true
        customer:
          $ref: '#/components/schemas/SellerOrderItemCustomer'
        product:
          $ref: '#/components/schemas/SellerOrderItemProduct'
        quantity:
          type: integer
        unitPrice:
          type: number
        subtotal:
          type: number
        itemStatus:
          type: string
        holdStatus:
          type: string
        holdAmount:
          type: number
        deliveredAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        credential:
          type: string
          nullable: true

    SellerOrderItemsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/SellerOrderItem'
            pagination:
              type: object
              properties:
                total:
                  type: integer
                limit:
                  type: integer
                skip:
                  type: integer

    # Support Schemas
    Conversation:
      type: object
      properties:
        _id:
          type: string
        type:
          type: string
          enum: [OrderItem, Shop, Support]
        customerUserId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/UserBasic'
        sellerUserId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/UserBasic'
          nullable: true
        staffUserId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/UserBasic'
          nullable: true
        shopId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/ShopBasic'
          nullable: true
        orderItemId:
          type: string
          nullable: true
        ticketId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/TicketBasic'
          nullable: true
        status:
          type: string
          enum: [Open, Closed, Blocked]
        lastMessageAt:
          type: string
          format: date-time
          nullable: true
        lastMessagePreview:
          type: string
          nullable: true
        unreadCount:
          type: object
          additionalProperties:
            type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserBasic:
      type: object
      properties:
        _id:
          type: string
        fullName:
          type: string
        email:
          type: string
        avatar:
          type: string
          nullable: true

    ShopBasic:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        logo:
          type: string
          nullable: true

    TicketBasic:
      type: object
      properties:
        _id:
          type: string
        ticketCode:
          type: string
        title:
          type: string
        status:
          type: string
        priority:
          type: string

    CreateConversationRequest:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [OrderItem, Shop]
        shopId:
          type: string
          description: Required for Shop type
        orderItemId:
          type: string
          description: Required for OrderItem type

    ConversationResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Conversation'

    ConversationsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            conversations:
              type: array
              items:
                $ref: '#/components/schemas/Conversation'
            total:
              type: integer
            page:
              type: integer
            totalPages:
              type: integer

    Message:
      type: object
      properties:
        _id:
          type: string
        conversationId:
          type: string
        senderUserId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/UserBasic'
        messageType:
          type: string
          enum: [Text, System, Attachment]
        body:
          type: string
          nullable: true
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/MessageAttachment'
        isInternal:
          type: boolean
          description: Internal note visible only to staff
        sentAt:
          type: string
          format: date-time
        readAt:
          type: string
          format: date-time
          nullable: true
        readBy:
          type: array
          items:
            type: string
        isDeleted:
          type: boolean

    MessageAttachment:
      type: object
      properties:
        url:
          type: string
        type:
          type: string
        fileName:
          type: string
        fileSize:
          type: integer

    SendMessageRequest:
      type: object
      required:
        - conversationId
        - messageType
      properties:
        conversationId:
          type: string
        messageType:
          type: string
          enum: [Text, Attachment]
        body:
          type: string
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/MessageAttachment'
        isInternal:
          type: boolean
          description: Mark as internal note (staff only)

    MessageResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Message'

    MessagesResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            messages:
              type: array
              items:
                $ref: '#/components/schemas/Message'
            total:
              type: integer
            hasMore:
              type: boolean

    Ticket:
      type: object
      properties:
        _id:
          type: string
        ticketCode:
          type: string
          description: Auto-generated ticket code (e.g., TK250204001)
        customerUserId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/UserBasic'
        orderItemId:
          type: string
        title:
          type: string
        content:
          type: string
        type:
          type: string
          enum: [Complaint, Dispute, General]
        priority:
          type: string
          enum: [Low, Medium, High, Urgent]
        status:
          type: string
          enum: [Open, InReview, NeedMoreInfo, Resolved, Closed]
        assignedToUserId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/UserBasic'
          nullable: true
        resolutionType:
          type: string
          enum: [None, FullRefund, PartialRefund, Replacement, NoAction]
        refundAmount:
          type: number
          nullable: true
        decidedByUserId:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/UserBasic'
          nullable: true
        decisionNote:
          type: string
          nullable: true
        decidedAt:
          type: string
          format: date-time
          nullable: true
        escalatedAt:
          type: string
          format: date-time
          nullable: true
        escalatedByUserId:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateTicketRequest:
      type: object
      required:
        - orderItemId
        - title
        - content
      properties:
        orderItemId:
          type: string
        title:
          type: string
          minLength: 5
          maxLength: 200
        content:
          type: string
          minLength: 10
          maxLength: 2000
        type:
          type: string
          enum: [Complaint, Dispute, General]
          default: General
        priority:
          type: string
          enum: [Low, Medium, High]
          default: Medium

    UpdateTicketRequest:
      type: object
      properties:
        status:
          type: string
          enum: [Open, InReview, NeedMoreInfo, Resolved, Closed]
        priority:
          type: string
          enum: [Low, Medium, High, Urgent]
        assignedToUserId:
          type: string
        resolutionType:
          type: string
          enum: [None, FullRefund, PartialRefund, Replacement, NoAction]
        refundAmount:
          type: number
        decisionNote:
          type: string

    TicketResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Ticket'

    TicketsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            tickets:
              type: array
              items:
                $ref: '#/components/schemas/Ticket'
            total:
              type: integer
            page:
              type: integer
            totalPages:
              type: integer

    TicketStats:
      type: object
      properties:
        total:
          type: integer
        byStatus:
          type: object
          additionalProperties:
            type: integer
        byPriority:
          type: object
          additionalProperties:
            type: integer
        avgResolutionTime:
          type: number
          description: Average resolution time in hours
